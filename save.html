<!DOCTYPE html>
<html>
    <head>
        <title>DEW - Save a File</title>
        <meta charset="UTF-8">
    </head>
    <body>
        <div>Saving Your Changes...</div>
        <script src="js/angular/angular.min.js"></script>
        <script src="js/gist.js"></script>
        <script src="js/jquery-1.10.2.js"></script>
        <script type="text/javascript">
            var code = window.location.search.match(/code=[0-9a-f]*/)[0].substring(5);
//            var gistid = unescape(window.location.search).match(/gistid=[0-9]*/)[0].substring(7);

            alert(code);
    
            if (true) { //gistid === localStorage.gistid) {
                $.ajax({
                    type: 'POST',
                    url: "https://github.com/login/oauth/access_token?client_id=13479cb2e9dd5f762848&client_secret=1c1feea05904a92aee0eba0fe432c2915bdc0129&code=" + code,
                    crossDomain: true,
                    data: '{}',
                    dataType: 'json',
                    success: function(responseData, textStatus, jqXHR) {
                        var value = responseData.access_token;
                        alert(value);
                    },
                    error: function (responseData, textStatus, errorThrown) {
                        alert('POST failed.');
                    }
                });                

              if (false) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', "https://github.com/login/oauth/access_token?client_id=13479cb2e9dd5f762848&client_secret=1c1feea05904a92aee0eba0fe432c2915bdc0129&code=" + code, false);
                xhr.setRequestHeader("Accept", "application/json");
                xhr.withCredentials = true;
                xhr.onreadystatechange = function(ev) {
                    if (xhr.status !== 200 || xhr.readyState !== 4) {
                        return;
                    }
                    var r = eval('(' + xhr.responseText + ')');
                    alert(r.access_token);
                    angular.element(document).ready(function() {
                        angular.module('fork', []);
                        angular.bootstrap(document, ['fork']);
                        var gh = new GitHub(angular.$http);
                        var yes = false;
                        if (yes) {
                            gh.forkGist(state).then(function(ev) {
                                var id = ev.id;
                                var files = ev.files;

                                gh.updateGist(id, {
                                    "files": files
                                }).then(function() {
                                    window.location.href = window.location.href.match(/.*\//) + "#" + id;
                                });
                            });
                        }
                    });
                }
                
                xhr.send();
              }
            }
        </script>
        <!--
        <script type="text/javascript">
            var whereTo = unescape(window.location.search.match(/state=[^&]*/)[0].substring(6)) + window.location.search;
            window.location = whereTo;
        </script>
        -->
    </body>
</html>
